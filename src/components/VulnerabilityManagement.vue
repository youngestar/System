<template>
  <p class="title">漏洞维护 - 漏洞审查数目</p>
  <div ref="chartRef" :style="{ width: props.width, height: props.height }"></div>
</template>

<script setup lang="ts">
// props 传参
const props = withDefaults(
  defineProps<{
    height?: string // 必传，类型为 string
    width?: string // 可选，类型为 string
  }>(),
  {
    height: '27vh',
    width: '100%', // 默认值（如果未传 width，则使用 '100%'）
  },
)

import { onBeforeUnmount, onMounted, ref } from 'vue'
// 按需引入 echarts 核心模块
import * as echarts from 'echarts/core'
// 引入需要的组件
import {
  TitleComponent,
  ToolboxComponent,
  TooltipComponent,
  GridComponent,
  LegendComponent,
} from 'echarts/components'
// 引入折线图图表
import { LineChart } from 'echarts/charts'
// 引入过渡效果
import { UniversalTransition } from 'echarts/features'
// 引入 Canvas 渲染器
import { CanvasRenderer } from 'echarts/renderers'

// 注册必须的组件
echarts.use([
  TitleComponent,
  ToolboxComponent,
  TooltipComponent,
  GridComponent,
  LegendComponent,
  LineChart,
  CanvasRenderer,
  UniversalTransition,
])

// 创建 ref 引用图表容器
const chartRef = ref(null)
// 用于存储 ECharts 实例
let myChart = null
// 定义 option 变量，使其在全局作用域可访问
let option = null

// 初始化图表的函数
const initChart = () => {
  // 获取图表容器 DOM 元素
  const chartDom = chartRef.value
  if (chartDom) {
    // 初始化 ECharts 实例
    myChart = echarts.init(chartDom)
    // 配置图表选项
    option = {
      color: ['#80FFA5', '#00DDFF', '#37A2FF', '#FF0087', '#FFBF00'],
      title: {
        text: '',
        textStyle: {
          color: '#475567',
          fontSize: 16,
        },
      },
      tooltip: {
        trigger: 'axis',
        axisPointer: {
          type: 'cross',
          label: {
            backgroundColor: '#6a7985',
            fontSize: 14,
          },
        },
        textStyle: {
          fontSize: 12,
        },
        extraCssText: `
        width: auto;
        height: auto;
        .echarts-tooltip .echarts-tooltip-series-label span {
            width: 50px;
            height: 50px;
        }
        `,
      },
      legend: {
        data: ['SQL 注入', '跨站脚本攻击（XSS）', '跨站请求伪造（CSRF）', '弱口令', '访问控制失效'],
        textStyle: {
          color: '#3C9DFF',
          fontSize: 14,
        },
        itemWidth: 20,
        itemHeight: 14,
        icon: 'roundRect',
        padding: [5, 10], // 图例内边距
      },
      toolbox: {
        feature: {
          saveAsImage: {},
        },
        iconStyle: {
          fontSize: 12,
        },
        itemSize: 16, // 工具箱图标大小
        itemGap: 10, // 工具箱图标间距
      },
      grid: {
        left: '3%',
        right: '4%',
        bottom: '3%',
        top: '20%',
        containLabel: true,
      },
      xAxis: [
        {
          type: 'category',
          boundaryGap: false,
          data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
          axisLabel: {
            color: '#475567',
            fontSize: 12,
          },
          axisLine: {
            lineStyle: {
              width: 1,
            },
          },
          axisTick: {
            length: 5,
          },
          splitLine: {
            lineStyle: {
              width: 1,
            },
          },
        },
      ],
      yAxis: [
        {
          type: 'value',
          axisLabel: {
            color: '#475567',
            fontSize: 12,
          },
          axisLine: {
            lineStyle: {
              width: 1,
            },
          },
          axisTick: {
            length: 5,
          },
          splitLine: {
            lineStyle: {
              width: 1,
            },
          },
        },
      ],
      series: [
        {
          name: 'SQL 注入',
          type: 'line',
          stack: 'Total',
          smooth: true,
          lineStyle: {
            width: 2,
          },
          showSymbol: false,
          areaStyle: {
            opacity: 0.8,
            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
              {
                offset: 0,
                color: 'rgb(128, 255, 165)',
              },
              {
                offset: 1,
                color: 'rgb(1, 191, 236)',
              },
            ]),
          },
          emphasis: {
            focus: 'series',
          },
          label: {
            fontSize: 12,
          },
          data: [14, 23, 10, 26, 90, 34, 25],
        },
        {
          name: '跨站脚本攻击（XSS）',
          type: 'line',
          stack: 'Total',
          smooth: true,
          lineStyle: {
            width: 2,
          },
          showSymbol: false,
          areaStyle: {
            opacity: 0.8,
            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
              {
                offset: 0,
                color: 'rgb(0, 221, 255)',
              },
              {
                offset: 1,
                color: 'rgb(77, 119, 255)',
              },
            ]),
          },
          emphasis: {
            focus: 'series',
          },
          label: {
            fontSize: 12,
          },
          data: [12, 28, 11, 23, 22, 34, 31],
        },
        {
          name: '跨站请求伪造（CSRF）',
          type: 'line',
          stack: 'Total',
          smooth: true,
          lineStyle: {
            width: 2,
          },
          showSymbol: false,
          areaStyle: {
            opacity: 0.8,
            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
              {
                offset: 0,
                color: 'rgb(55, 162, 255)',
              },
              {
                offset: 1,
                color: 'rgb(116, 21, 219)',
              },
            ]),
          },
          emphasis: {
            focus: 'series',
          },
          label: {
            fontSize: 12,
          },
          data: [32, 13, 20, 33, 19, 13, 22],
        },
        {
          name: '弱口令',
          type: 'line',
          stack: 'Total',
          smooth: true,
          lineStyle: {
            width: 2,
          },
          showSymbol: false,
          areaStyle: {
            opacity: 0.8,
            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
              {
                offset: 0,
                color: 'rgb(255, 0, 135)',
              },
              {
                offset: 1,
                color: 'rgb(135, 0, 157)',
              },
            ]),
          },
          emphasis: {
            focus: 'series',
          },
          label: {
            fontSize: 12,
          },
          data: [22, 40, 23, 13, 19, 23, 12],
        },
        {
          name: '访问控制失效',
          type: 'line',
          stack: 'Total',
          smooth: true,
          lineStyle: {
            width: 2,
          },
          showSymbol: false,
          label: {
            show: true,
            position: 'top',
            fontSize: 12,
          },
          areaStyle: {
            opacity: 0.8,
            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
              {
                offset: 0,
                color: 'rgb(255, 191, 0)',
              },
              {
                offset: 1,
                color: 'rgb(224, 62, 76)',
              },
            ]),
          },
          emphasis: {
            focus: 'series',
          },
          data: [22, 30, 18, 23, 21, 29, 15],
        },
      ],
    }
    // 应用配置项
    myChart.setOption(option)
  }
}

// 字体等自适应函数
function adjustOption() {
  if (!option || !myChart) return
  const width = window.innerWidth
  const height = window.innerHeight

  // 根据窗口动态调节大小
  const baseSize = 1
  const scaleFactor = Math.min(width / 1920, height / 1080) // 以 1920x1080 为基准

  // 调整标题字体大小
  option.title.textStyle.fontSize = 16 * 1.2 * scaleFactor
  // 调整图例字体大小
  option.legend.textStyle.fontSize = 14 * scaleFactor
  // 调整提示框字体大小
  option.tooltip.textStyle.fontSize = 12 * scaleFactor
  option.tooltip.axisPointer.label.fontSize = 14 * scaleFactor // 调整提示框坐标轴指示器标签字体大小
  // 调整工具箱图标字体大小
  option.toolbox.iconStyle.fontSize = 12 * scaleFactor
  // 调整 x 轴标签字体大小
  option.xAxis[0].axisLabel.fontSize = 12 * scaleFactor
  // 调整 y 轴标签字体大小
  option.yAxis[0].axisLabel.fontSize = 12 * scaleFactor
  // 调整系列标签字体大小
  option.series.forEach((series) => {
    series.label.fontSize = 12 * scaleFactor
  })

  // 调整图例大小
  option.legend.itemWidth = 20 * scaleFactor
  option.legend.itemHeight = 14 * scaleFactor
  option.legend.padding = [5 * scaleFactor, 10 * scaleFactor]

  // 调整工具箱图标大小和间距
  option.toolbox.itemSize = 16 * scaleFactor
  option.toolbox.itemGap = 10 * scaleFactor

  // 调整 x 轴线段大小
  option.xAxis[0].axisLine.lineStyle.width = 1 * scaleFactor
  // 调整 x 轴刻度长度
  option.xAxis[0].axisTick.length = 5 * scaleFactor
  // 调整 x 轴分割线宽度
  option.xAxis[0].splitLine.lineStyle.width = 1 * scaleFactor

  // 调整 y 轴线段大小
  option.yAxis[0].axisLine.lineStyle.width = 1 * scaleFactor
  // 调整 y 轴刻度长度
  option.yAxis[0].axisTick.length = 5 * scaleFactor
  // 调整 y 轴分割线宽度
  option.yAxis[0].splitLine.lineStyle.width = 1 * scaleFactor

  // 调整系列线条宽度
  option.series.forEach((series) => {
    series.lineStyle.width = 2 * scaleFactor
  })

  // 调整提示框里的图例大小
  const tooltipLegendSize = 14 * scaleFactor
  option.tooltip.extraCssText = `
    width: auto;
    height: auto;
    .echarts-tooltip .echarts-tooltip-series-label span {
      width: ${tooltipLegendSize}px;
      height: ${tooltipLegendSize}px;
    }
  `

  // 将更新后的 option 重新应用到图表
  myChart.setOption(option)
}

// 处理窗口大小变化的函数
const resizeChart = () => {
  if (myChart) {
    myChart.resize()
    adjustOption()
  }
}

// 组件挂载后执行的操作
onMounted(() => {
  initChart()
  // 监听窗口大小变化，实现响应式
  window.addEventListener('resize', resizeChart)
  adjustOption()
})

// 组件销毁前执行的操作
onBeforeUnmount(() => {
  // 移除事件监听器
  window.removeEventListener('resize', resizeChart)
  if (myChart) {
    // 销毁图表实例
    myChart.dispose()
  }
})
</script>

<style scoped>
.title {
  font-size: 1.6vh;
  margin-left: 1em;
  margin-top: 1em;
}
</style>
